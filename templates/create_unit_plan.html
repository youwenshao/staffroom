<!-- templates/create_unit_plan.html -->
{% extends "base.html" %}

{% block title %}Create Unit Plan - staffroom{% endblock %}

{% block styles %}
<style>
    .form-container {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #DDA52D;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chinese-section {
        border-left: 4px solid #69256B;
    }
    .form-section-title {
        color: #DDA52D;
        border-bottom: 2px solid #DDA52D;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
    }
    .chinese-section .form-section-title {
        color: #69256B;
        border-bottom: 2px solid #69256B;
    }
    .references-section {
        border-left: 4px solid #6c757d;
    }
    .references-section .form-section-title {
        color: #6c757d;
        border-bottom: 2px solid #6c757d;
    }
    .optional-field {
        font-style: italic;
        color: #6c757d;
    }
    .table-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 5px;
        margin-bottom: 1rem;
    }
    .language-selector {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-language-section {
        display: none;
    }
    .form-language-section.active {
        display: block;
    }
    @media (max-width: 768px) {
        .form-container {
            padding: 1rem;
        }
        .form-section {
            padding: 1rem;
        }
        .table-section {
            padding: 0.75rem;
        }
        .day-section {
            padding: 0.75rem !important;
        }
        .form-control, .form-select, textarea {
            font-size: 0.9rem;
        }
    }
    @media (max-width: 576px) {
        .form-container {
            padding: 0.75rem;
            border-radius: 5px;
        }
        .form-section {
            padding: 0.75rem;
        }
        .row > [class*="col-"] {
            margin-bottom: 0.5rem;
        }
        .day-section .row > [class*="col-"] {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<h2 class="text-center mb-4">Create a New Unit Plan</h2>

<div class="form-container">
    <form method="POST" action="{{ url_for('create_unit') }}">
        
        <!-- Language Selection -->
        <div class="language-selector">
            <label class="form-label fw-bold mb-2">Select Template Language:</label>
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="template_language" id="lang_english" value="english" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="lang_english">English</label>
                
                <input type="radio" class="btn-check" name="template_language" id="lang_chinese" value="chinese" autocomplete="off">
                <label class="btn btn-outline-primary" for="lang_chinese">中文 (Chinese)</label>
            </div>
        </div>
        
        <!-- ENGLISH UNIT PLAN SECTION -->
        <div class="form-section form-language-section active" id="english-section">
            <h4 class="form-section-title">English Version</h4>
            
            <!-- Basic Information -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Unit/Topic</label>
                    <input type="text" class="form-control" name="unit_topic" value="{{ default_unit_topic }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Number of Lessons</label>
                    <input type="number" class="form-control" name="number_of_lessons" value="{{ default_number_lessons }}" required>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Period</label>
                    <input type="text" class="form-control" name="period" placeholder="DD/MM/YYYY to DD/MM/YYYY" value="{{ default_period }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Class</label>
                    <input type="text" class="form-control" name="class_info" value="{{ default_class }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Level</label>
                    <select class="form-select" name="class_level" required>
                        <option value="Primary">Primary</option>
                        <option value="Secondary">Secondary</option>
                    </select>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Class Size</label>
                    <input type="number" class="form-control" name="class_size" value="{{ default_class_size }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Boys</label>
                    <input type="number" class="form-control" name="boys" placeholder="Boys" value="{{ default_boys }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Girls</label>
                    <input type="number" class="form-control" name="girls" placeholder="Girls" value="{{ default_girls }}" required>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Teaching Venue/Facilities</label>
                    <input type="text" class="form-control" name="venue" value="{{ default_venue }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Equipment</label>
                    <input type="text" class="form-control" name="equipment" value="{{ default_equipment }}" required>
                </div>
            </div>

            <!-- Unit Overview -->
            <div class="mb-4">
                <label class="form-label">Unit Overview</label>
                <textarea class="form-control" name="unit_overview" rows="3" required></textarea>
            </div>

            <!-- Skills and Concepts Table -->
            <div class="table-section">
                <h6>Unit Details</h6>
                <div class="mb-3">
                    <label class="form-label">Skills/Topics to be taught</label>
                    <textarea class="form-control" name="skills_topics" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Movement Concepts (Body, Space, Time, Efforts)</label>
                    <textarea class="form-control" name="movement_concepts" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Student's Previous Knowledge</label>
                    <textarea class="form-control" name="previous_knowledge" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Expected Learning Outcomes</label>
                    <textarea class="form-control" name="learning_outcomes" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label optional-field">Assessments (if any)</label>
                    <textarea class="form-control" name="assessments" rows="2"></textarea>
                </div>
            </div>

            <!-- Objectives -->
            <div class="table-section">
                <h6>Unit Objectives - Students will be able to:</h6>
                <div class="mb-3">
                    <label class="form-label">Psychomotor Performance Objectives</label>
                    <textarea class="form-control" name="psychomotor_obj" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Cognitive Performance Objectives</label>
                    <textarea class="form-control" name="cognitive_obj" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Affective Objectives</label>
                    <textarea class="form-control" name="affective_obj" rows="2" required></textarea>
                </div>
            </div>

            <!-- Student Characteristics -->
            <div class="table-section">
                <h6>Student Characteristics</h6>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>Domain</strong></div>
                    <div class="col-md-4"><strong>Characteristics</strong></div>
                    <div class="col-md-4"><strong>Matters to be Noted</strong></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Psychomotor</label>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="psychomotor_chars" rows="2" required></textarea>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="psychomotor_notes" rows="2" required></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Cognitive</label>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="cognitive_chars" rows="2" required></textarea>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="cognitive_notes" rows="2" required></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Affective</label>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="affective_chars" rows="2" required></textarea>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="affective_notes" rows="2" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Approaches -->
            <div class="table-section">
                <h6>Approaches/Ways to Handle</h6>
                <div class="mb-3">
                    <label class="form-label">Individual Differences between Students</label>
                    <textarea class="form-control" name="individual_differences" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Enhancing Students' Motivation in Learning</label>
                    <textarea class="form-control" name="enhancing_motivation" rows="2" required></textarea>
                </div>
            </div>

            <!-- Safety -->
            <div class="mb-4">
                <label class="form-label">Safety Precautions</label>
                <textarea class="form-control" name="safety_precautions" rows="2" required></textarea>
            </div>

            <!-- Unit Contents (Multiple Days) -->
            <div class="table-section">
                <h6>Unit Contents</h6>
                <p class="text-muted small">Add details for each lesson in the unit</p>
                
                <div id="unit-days-container-en">
                    <!-- Dynamic days will be added here -->
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-day-btn-en">
                    + Add Day
                </button>
            </div>

            <!-- Other Considerations -->
            <div class="mb-4">
                <label class="form-label">Other Considerations</label>
                <textarea class="form-control" name="other_considerations" rows="3" required></textarea>
            </div>
        </div>

        <!-- CHINESE UNIT PLAN SECTION -->
        <div class="form-section chinese-section form-language-section" id="chinese-section">
            <h4 class="form-section-title">中文版本 Chinese Version</h4>
            
            <!-- Basic Information - Chinese -->
            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">單元/主題</label>
                    <input type="text" class="form-control" name="unit_topic_zh" value="{{ default_unit_topic_zh }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">課節總數</label>
                    <input type="number" class="form-control" name="number_of_lessons_zh" value="{{ default_number_lessons }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <!-- Spacer to maintain alignment -->
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">期間</label>
                    <input type="text" class="form-control" name="period_zh" placeholder="DD/MM/YYYY 至 DD/MM/YYYY" value="{{ default_period_zh }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">班別</label>
                    <input type="text" class="form-control" name="class_info_zh" value="{{ default_class_zh }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">類別</label>
                    <select class="form-select" name="class_level_zh" required>
                        <option value="小學">小學</option>
                        <option value="中學">中學</option>
                    </select>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <label class="form-label">班級人數</label>
                    <input type="number" class="form-control" name="class_size_zh" value="{{ default_class_size }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">男生</label>
                    <input type="number" class="form-control" name="boys_zh" placeholder="男生" value="{{ default_boys }}" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">女生</label>
                    <input type="number" class="form-control" name="girls_zh" placeholder="女生" value="{{ default_girls }}" required>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6 mb-3">
                    <label class="form-label">教學場地/設施</label>
                    <input type="text" class="form-control" name="venue_zh" value="{{ default_venue_zh }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">器材/用具</label>
                    <input type="text" class="form-control" name="equipment_zh" value="{{ default_equipment_zh }}" required>
                </div>
            </div>

            <!-- Chinese Unit Overview -->
            <div class="mb-4">
                <label class="form-label">單元概述</label>
                <textarea class="form-control" name="unit_overview_zh" rows="3" required></textarea>
            </div>

            <!-- Chinese Skills and Concepts Table -->
            <div class="table-section">
                <h6>單元詳細資料</h6>
                <div class="mb-3">
                    <label class="form-label">單元教學重點</label>
                    <textarea class="form-control" name="skills_topics_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">單元所需的動作概念 (身體、空間、時間、力度)</label>
                    <textarea class="form-control" name="movement_concepts_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">學生已有知識</label>
                    <textarea class="form-control" name="previous_knowledge_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">預期的學生學習成果</label>
                    <textarea class="form-control" name="learning_outcomes_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label optional-field">評核（如有）</label>
                    <textarea class="form-control" name="assessments_zh" rows="2"></textarea>
                </div>
            </div>

            <!-- Chinese Objectives -->
            <div class="table-section">
                <h6>本單元目標：學生將能</h6>
                <div class="mb-3">
                    <label class="form-label">技能方面</label>
                    <textarea class="form-control" name="psychomotor_obj_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">認知方面</label>
                    <textarea class="form-control" name="cognitive_obj_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">情意方面</label>
                    <textarea class="form-control" name="affective_obj_zh" rows="2" required></textarea>
                </div>
            </div>

            <!-- Chinese Student Characteristics -->
            <div class="table-section">
                <h6>學生特徵</h6>
                <div class="row mb-3">
                    <div class="col-md-4"><strong>範疇</strong></div>
                    <div class="col-md-4"><strong>特徵</strong></div>
                    <div class="col-md-4"><strong>注意事項</strong></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">技能</label>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="psychomotor_chars_zh" rows="2" required></textarea>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="psychomotor_notes_zh" rows="2" required></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">認知</label>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="cognitive_chars_zh" rows="2" required></textarea>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="cognitive_notes_zh" rows="2" required></textarea>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">情意</label>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="affective_chars_zh" rows="2" required></textarea>
                    </div>
                    <div class="col-md-4">
                        <textarea class="form-control" name="affective_notes_zh" rows="2" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Chinese Approaches -->
            <div class="table-section">
                <h6>處理方法</h6>
                <div class="mb-3">
                    <label class="form-label">學生學習個別差異</label>
                    <textarea class="form-control" name="individual_differences_zh" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">提升學生學習動機</label>
                    <textarea class="form-control" name="enhancing_motivation_zh" rows="2" required></textarea>
                </div>
            </div>

            <!-- Chinese Safety -->
            <div class="mb-4">
                <label class="form-label">安全注意事項</label>
                <textarea class="form-control" name="safety_precautions_zh" rows="2" required></textarea>
            </div>

            <!-- Chinese Unit Contents -->
            <div class="table-section">
                <h6>單元內容</h6>
                <p class="text-muted small">為單元中的每個課節添加詳細資料</p>
                
                <div id="unit-days-container-zh">
                    <!-- Dynamic days will be added here -->
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="add-day-btn-zh">
                    + 新增課節
                </button>
            </div>

            <!-- Chinese Other Considerations -->
            <div class="mb-4">
                <label class="form-label">其他注意事項</label>
                <textarea class="form-control" name="other_considerations_zh" rows="3" required></textarea>
            </div>
        </div>

        <!-- REFERENCES SECTION -->
        <div class="form-section references-section">
            <!-- English References -->
            <div class="mb-4 form-language-section active" id="english-refs-section">
                <h4 class="form-section-title">References</h4>
                <label class="form-label">References</label>
                <textarea class="form-control" name="references" rows="3" placeholder="List your references, textbooks, websites, or other resources used in planning this unit"></textarea>
            </div>

            <!-- Chinese References -->
            <div class="mb-4 form-language-section" id="chinese-refs-section">
                <h4 class="form-section-title">參考資料</h4>
                <label class="form-label">參考資料</label>
                <textarea class="form-control" name="references_zh" rows="3" placeholder="列出您在規劃此單元時使用的參考資料、教科書、網站或其他資源"></textarea>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">Cancel</a>
            <button type="submit" class="btn btn-primary">Generate Unit Plan</button>
        </div>
    </form>
</div>

<script>
    // Language selection toggle
    document.addEventListener('DOMContentLoaded', function() {
        const langRadios = document.querySelectorAll('input[name="template_language"]');
        const englishSection = document.getElementById('english-section');
        const chineseSection = document.getElementById('chinese-section');
        
        const markInitialRequired = (section) => {
            section.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.required) {
                    field.dataset.wasRequired = 'true';
                }
            });
        };
        
        const toggleSection = (section, enable) => {
            section.querySelectorAll('input, select, textarea').forEach(field => {
                if (enable) {
                    if (field.dataset.wasRequired === 'true') {
                        field.required = true;
                    }
                } else {
                    if (field.required) {
                        field.dataset.wasRequired = 'true';
                    }
                    field.required = false;
                }
            });
        };
        
        const englishRefsSection = document.getElementById('english-refs-section');
        const chineseRefsSection = document.getElementById('chinese-refs-section');
        
        const setLanguage = (lang) => {
            const englishActive = lang === 'english';
            englishSection.classList.toggle('active', englishActive);
            chineseSection.classList.toggle('active', !englishActive);
            if (englishRefsSection) englishRefsSection.classList.toggle('active', englishActive);
            if (chineseRefsSection) chineseRefsSection.classList.toggle('active', !englishActive);
            toggleSection(englishSection, englishActive);
            toggleSection(chineseSection, !englishActive);
        };
        
        markInitialRequired(englishSection);
        markInitialRequired(chineseSection);
        setLanguage('english');
        
        langRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                setLanguage(this.value);
            });
        });
        
        // Dynamic day rows functionality
        let dayCounterEn = 0;
        let dayCounterZh = 0;
        
        // English section
        const addDayBtnEn = document.getElementById('add-day-btn-en');
        const daysContainerEn = document.getElementById('unit-days-container-en');
        
        function addDayRow(lang) {
            const container = lang === 'en' ? daysContainerEn : document.getElementById('unit-days-container-zh');
            const counter = lang === 'en' ? ++dayCounterEn : ++dayCounterZh;
            const prefix = lang === 'en' ? '' : '_zh';
            const dayLabel = lang === 'en' ? 'Day' : '課節';
            const dateLabel = lang === 'en' ? 'Date' : '日期';
            const themeLabel = lang === 'en' ? 'Theme & Content' : '主題與內容';
            const activitiesLabel = lang === 'en' ? 'Learning Activities' : '活動內容';
            
            const dayRow = document.createElement('div');
            dayRow.className = 'day-section mb-4 p-3 border rounded';
            dayRow.dataset.dayIndex = counter;
            dayRow.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6>${dayLabel} ${counter}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-day-btn">Remove</button>
                </div>
                <div class="mb-3">
                    <label class="form-label">${dateLabel}</label>
                    <input type="text" class="form-control" name="day_${counter}_date${prefix}" placeholder="DD/MM/YYYY" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">${themeLabel}</label>
                    <textarea class="form-control" name="day_${counter}_theme${prefix}" rows="2" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">${activitiesLabel}</label>
                    <textarea class="form-control" name="day_${counter}_activities${prefix}" rows="2" required></textarea>
                </div>
            `;
            
            container.appendChild(dayRow);
            dayRow.querySelectorAll('input, textarea').forEach(field => {
                field.dataset.wasRequired = 'true';
                field.required = true;
            });
            
            // Add remove functionality
            dayRow.querySelector('.remove-day-btn').addEventListener('click', function() {
                dayRow.remove();
            });
        }
        
        addDayBtnEn.addEventListener('click', function() {
            addDayRow('en');
        });
        
        // Chinese section
        const addDayBtnZh = document.getElementById('add-day-btn-zh');
        
        addDayBtnZh.addEventListener('click', function() {
            addDayRow('zh');
        });

        // Pre-populate 5 days for both languages
        for (let i = 0; i < 5; i++) {
            addDayRow('en');
            addDayRow('zh');
        }

        // Ensure required flags reflect the currently selected language after prepopulation
        setLanguage(document.querySelector('input[name="template_language"]:checked')?.value || 'english');
    });
</script>
{% endblock %}
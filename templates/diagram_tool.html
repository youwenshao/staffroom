{% extends "base.html" %}

{% block title %}Diagram Tool - staffroom{% endblock %}

{% block styles %}
<style>
/* All your existing CSS styles from diagram-tool.css go here */
.diagram-container {
    height: 100vh;
    padding: 0;
}

.sidebar {
    background-color: #f8f9fa;
    border-right: 1px solid #dee2e6;
    height: 100vh;
    overflow-y: auto;
    padding: 1rem;
}

.tool-section {
    margin-bottom: 1.5rem;
}

.tool-section h5 {
    color: #495057;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
    font-weight: 600;
}

.tool-btn {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    width: 100%;
}

.tool-btn:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
}

.tool-btn.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.tool-icon {
    width: 24px;
    height: 24px;
    margin-right: 0.5rem;
    border: 1px solid #333;
    position: relative;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.teacher-icon {
    background: transparent;
    border-radius: 50%;
    border-color: #333;
}

.teacher-icon::before,
.teacher-icon::after {
    content: '';
    position: absolute;
    background: #333;
}

.teacher-icon::before {
    /* Eyes */
    width: 4px;
    height: 4px;
    border-radius: 50%;
    top: 7px;
    left: 6px;
    box-shadow: 8px 0 0 #333; /* Second eye */
}

.teacher-icon::after {
    /* Smile */
    width: 8px;
    height: 4px;
    border-radius: 0 0 4px 4px;
    bottom: 6px;
    left: 8px;
}

.student-icon {
    border-radius: 50%;
    border-color: #333;
}

.facing-arrow-icon {
    background: transparent;
    position: relative;
}

.facing-arrow-icon::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 4px;
    right: 8px;
    height: 2px;
    background: #333;
    transform: translateY(-50%);
}

.facing-arrow-icon::after {
    content: '';
    position: absolute;
    right: 4px;
    top: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid #333;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    transform: translateY(-50%);
}

.movement-arrow-icon {
    background: transparent;
    position: relative;
}

.movement-arrow-icon::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 4px;
    right: 8px;
    height: 1px;
    background: repeating-linear-gradient(to right, #333, #333 2px, transparent 2px, transparent 4px);
    transform: translateY(-50%);
}

.movement-arrow-icon::after {
    content: '';
    position: absolute;
    right: 4px;
    top: 50%;
    width: 0;
    height: 0;
    border-left: 6px solid #333;
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
    transform: translateY(-50%);
}

.area-icon {
    background: transparent;
    border: 1px dashed #333;
}

/* FIXED: Obstacle icon - simplified approach */
.obstacle-icon {
    background: transparent;
    position: relative;
}

.obstacle-icon::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 16px solid #333;
}

/* FIXED: Equipment icon - simplified approach */
.equipment-icon {
    background: transparent;
    position: relative;
}

.equipment-icon::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(45deg);
    width: 16px;
    height: 16px;
    border: 1px solid #333;
}

.select-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    background: transparent;
    border: 1px solid #333;
    font-size: 14px;
}

.eraser-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    background: transparent;
    border: 1px solid #333;
    color: #333;
    font-size: 14px;
}

.action-section {
    margin-top: 2rem;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.properties-section {
    margin-top: 2rem;
}

.properties-panel {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 1rem;
    min-height: 100px;
}

.canvas-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 0;
}

.canvas-header {
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.canvas-header h4 {
    margin: 0;
    flex: 1;
}

.canvas-controls {
    display: flex;
    gap: 0.5rem;
}

.canvas-wrapper {
    flex: 1;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

#diagramCanvas {
    border: 1px solid #dee2e6;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Property panel form styles */
.properties-panel .form-group {
    margin-bottom: 0.5rem;
}

.properties-panel label {
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
    display: block;
}

.properties-panel .form-control-sm {
    height: calc(1.5em + 0.5rem + 2px);
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid diagram-container">
    <div class="row">
        <!-- Sidebar with tools -->
        <div class="col-md-3 sidebar">
            <div class="tool-section">
                <h5>Tools</h5>
                <div class="tool-btn" data-type="select">
                    <div class="tool-icon select-icon">↖</div>
                    <span>Select (V)</span>
                </div>
                <div class="tool-btn" data-type="eraser">
                    <div class="tool-icon eraser-icon">✕</div>
                    <span>Eraser (E)</span>
                </div>
            </div>
            
            <div class="tool-section">
                <h5>People</h5>
                <div class="tool-btn" data-type="teacher">
                    <div class="tool-icon teacher-icon"></div>
                    <span>Teacher</span>
                </div>
                <div class="tool-btn" data-type="student">
                    <div class="tool-icon student-icon"></div>
                    <span>Student</span>
                </div>
            </div>
            
            <div class="tool-section">
                <h5>Directions</h5>
                <div class="tool-btn" data-type="facing-arrow">
                    <div class="tool-icon facing-arrow-icon"></div>
                    <span>Facing Direction</span>
                </div>
                <div class="tool-btn" data-type="movement-arrow">
                    <div class="tool-icon movement-arrow-icon"></div>
                    <span>Movement Path</span>
                </div>
            </div>
            
            <div class="tool-section">
                <h5>Equipment & Areas</h5>
                <div class="tool-btn" data-type="area">
                    <div class="tool-icon area-icon"></div>
                    <span>Area/Mat</span>
                </div>
                <div class="tool-btn" data-type="obstacle">
                    <div class="tool-icon obstacle-icon"></div>
                    <span>Obstacle</span>
                </div>
                <div class="tool-btn" data-type="equipment">
                    <div class="tool-icon equipment-icon"></div>
                    <span>Equipment</span>
                </div>
            </div>
            
            <div class="action-section">
                <h5>Actions</h5>
                <div class="action-buttons">
                    <button id="clearCanvas" class="btn btn-warning btn-sm">Clear Canvas</button>
                    <button id="downloadPNG" class="btn btn-success btn-sm">Download PNG</button>
                    <button id="backToForm" class="btn btn-secondary btn-sm">Back to Form</button>
                </div>
            </div>

            <div class="properties-section">
                <h5>Properties</h5>
                <div id="propertiesPanel" class="properties-panel">
                    <p class="text-muted">Select an object to edit properties</p>
                </div>
            </div>
        </div>
        
        <!-- Canvas area -->
        <div class="col-md-9 canvas-container">
            <div class="canvas-header">
                <h4>Class Organization Diagram</h4>
                <div class="canvas-controls">
                    <button id="toggleGrid" class="btn btn-outline-secondary btn-sm">Toggle Grid</button>
                    <button id="zoomIn" class="btn btn-outline-secondary btn-sm">Zoom In</button>
                    <button id="zoomOut" class="btn btn-outline-secondary btn-sm">Zoom Out</button>
                    <button id="resetZoom" class="btn btn-outline-secondary btn-sm">Reset Zoom</button>
                </div>
            </div>
            <div class="canvas-wrapper">
                <canvas id="diagramCanvas" width="800" height="600"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
// ... (keep all the JavaScript code exactly the same as in the previous version)
// The JavaScript doesn't need changes, only the CSS for the toolbar icons
console.log('Diagram tool script loading...');

class DiagramTool {
    constructor() {
        console.log('DiagramTool constructor called');
        this.canvas = null;
        this.currentTool = null;
        this.gridSize = 20;
        this.showGrid = true;
        this.zoomLevel = 1;
        this.isDrawingMode = false;
        
        this.init();
    }

    init() {
        console.log('Initializing DiagramTool...');
        this.setupCanvas();
        this.bindEvents();
        this.drawGrid();
        this.setCurrentTool('select'); // Start in selection mode by default
        console.log('DiagramTool initialization complete');
    }

    setupCanvas() {
        console.log('Setting up canvas...');
        try {
            this.canvas = new fabric.Canvas('diagramCanvas', {
                width: 800,
                height: 600,
                selection: true,
                preserveObjectStacking: true,
                stopContextMenu: true // Disable right-click context menu
            });
            console.log('Canvas created successfully');
        } catch (error) {
            console.error('Error creating canvas:', error);
            return;
        }

        // Enable resizing and rotation for all objects
        this.canvas.on('object:selected', (e) => {
            this.showProperties(e.target);
        });

        this.canvas.on('selection:cleared', () => {
            this.hideProperties();
        });

        // Double-click to delete (convenience feature)
        this.canvas.on('mouse:dblclick', (e) => {
            if (e.target && this.currentTool === 'select') {
                this.canvas.remove(e.target);
                this.canvas.requestRenderAll();
            }
        });
    }

    bindEvents() {
        // Tool selection
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.setCurrentTool(e.currentTarget.dataset.type);
            });
        });

        // Canvas click for adding objects - only in drawing mode
        this.canvas.on('mouse:down', (e) => {
            if (this.currentTool && this.currentTool !== 'select' && this.currentTool !== 'eraser' && !e.target) {
                this.addObject(e.pointer.x, e.pointer.y);
            }
            
            // Eraser tool functionality
            if (this.currentTool === 'eraser' && e.target) {
                this.canvas.remove(e.target);
                this.canvas.requestRenderAll();
            }
        });

        // Action buttons
        document.getElementById('clearCanvas').addEventListener('click', () => this.clearCanvas());
        document.getElementById('downloadPNG').addEventListener('click', () => this.downloadPNG());
        document.getElementById('backToForm').addEventListener('click', () => window.history.back());

        // Canvas controls
        document.getElementById('toggleGrid').addEventListener('click', () => this.toggleGrid());
        document.getElementById('zoomIn').addEventListener('click', () => this.zoom(0.1));
        document.getElementById('zoomOut').addEventListener('click', () => this.zoom(-0.1));
        document.getElementById('resetZoom').addEventListener('click', () => this.resetZoom());

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Delete key to remove selected objects
            if ((e.key === 'Delete' || e.key === 'Backspace') && this.canvas.getActiveObject()) {
                this.canvas.remove(this.canvas.getActiveObject());
                this.canvas.requestRenderAll();
                this.hideProperties();
            }
            
            // Escape key to clear selection
            if (e.key === 'Escape') {
                this.canvas.discardActiveObject();
                this.canvas.requestRenderAll();
                this.hideProperties();
            }
            
            // V key for selection tool
            if (e.key === 'v' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                this.setCurrentTool('select');
            }
            
            // E key for eraser tool
            if (e.key === 'e' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                this.setCurrentTool('eraser');
            }
        });
    }

    setCurrentTool(toolType) {
        this.currentTool = toolType;
        
        // Update canvas behavior based on tool
        if (toolType === 'select') {
            this.canvas.selection = true;
            this.canvas.defaultCursor = 'default';
            document.body.style.cursor = 'default';
        } else if (toolType === 'eraser') {
            this.canvas.selection = false;
            this.canvas.defaultCursor = 'crosshair';
            document.body.style.cursor = 'crosshair';
        } else {
            this.canvas.selection = false;
            this.canvas.defaultCursor = 'crosshair';
            document.body.style.cursor = 'crosshair';
        }
        
        // Update UI
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeBtn = document.querySelector(`[data-type="${toolType}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }

        // Clear selection when switching tools (except when switching to select)
        if (toolType !== 'select') {
            this.canvas.discardActiveObject();
            this.canvas.requestRenderAll();
        }

        // Update tooltip in properties panel
        this.updateTooltip();
    }

    updateTooltip() {
        const panel = document.getElementById('propertiesPanel');
        let tooltip = '';
        
        switch(this.currentTool) {
            case 'select':
                tooltip = '<p class="text-muted"><strong>Selection Tool</strong><br>• Click to select objects<br>• Drag to move<br>• Use handles to resize/rotate<br>• Press Delete to remove<br>• Double-click to quick delete</p>';
                break;
            case 'eraser':
                tooltip = '<p class="text-muted"><strong>Eraser Tool</strong><br>• Click on objects to delete them<br>• Press V for Selection tool</p>';
                break;
            default:
                tooltip = '<p class="text-muted"><strong>Drawing Tool</strong><br>• Click on canvas to add objects<br>• Press V for Selection tool<br>• Press E for Eraser tool</p>';
        }
        
        // Only show tooltip if no object is selected
        if (!this.canvas.getActiveObject()) {
            panel.innerHTML = tooltip;
        }
    }

    addObject(x, y) {
        let newObject;
        
        switch(this.currentTool) {
            case 'teacher':
                newObject = this.createTeacher(x, y);
                break;
            case 'student':
                newObject = this.createStudent(x, y);
                break;
            case 'facing-arrow':
                newObject = this.createFacingArrow(x, y);
                break;
            case 'movement-arrow':
                newObject = this.createMovementArrow(x, y);
                break;
            case 'area':
                newObject = this.createArea(x, y);
                break;
            case 'obstacle':
                newObject = this.createObstacle(x, y);
                break;
            case 'equipment':
                newObject = this.createEquipment(x, y);
                break;
        }

        if (newObject) {
            this.canvas.add(newObject);
            this.canvas.setActiveObject(newObject);
            this.canvas.requestRenderAll();
            this.showProperties(newObject);
        }
    }

    createTeacher(x, y) {
        // Create all the components first
        const circle = new fabric.Circle({
            radius: 20,
            fill: 'transparent',
            stroke: '#333333',
            strokeWidth: 3,
            originX: 'center',
            originY: 'center'
        });

        const leftEye = new fabric.Circle({
            radius: 2,
            left: -6,
            top: -5,
            fill: '#333333',
            originX: 'center',
            originY: 'center'
        });

        const rightEye = new fabric.Circle({
            radius: 2,
            left: 6,
            top: -5,
            fill: '#333333',
            originX: 'center',
            originY: 'center'
        });

        // Smile - using a proper curved path
        const smile = new fabric.Path('M -8 8 Q 0 12 8 8', {
            fill: 'transparent',
            stroke: '#333333',
            strokeWidth: 2,
            originX: 'center',
            originY: 'center'
        });

        // Create group with all objects
        const group = new fabric.Group([circle, leftEye, rightEye, smile], {
            left: x,
            top: y,
            hasControls: true,
            hasBorders: true,
            lockScalingFlip: true,
            originX: 'center',
            originY: 'center'
        });

        return group;
    }

    createStudent(x, y) {
        return new fabric.Circle({
            left: x,
            top: y,
            radius: 15,
            fill: 'transparent',
            stroke: '#333333',
            strokeWidth: 2,
            originX: 'center',
            originY: 'center',
            hasControls: true,
            hasBorders: true
        });
    }

    createFacingArrow(x, y) {
        const lineLength = 60;
        
        // Create the line
        const line = new fabric.Line([0, 0, lineLength, 0], {
            stroke: '#333333',
            strokeWidth: 3,
            strokeLineCap: 'round',
            originX: 'center',
            originY: 'center'
        });

        // Create arrowhead pointing right (triangle rotated 90 degrees)
        const arrowHead = new fabric.Triangle({
            left: lineLength,
            top: 0,
            width: 12,
            height: 12,
            fill: '#333333',
            angle: 90, // This rotates the triangle to point right
            originX: 'center',
            originY: 'center'
        });

        const group = new fabric.Group([line, arrowHead], {
            left: x,
            top: y,
            hasControls: true,
            hasBorders: true,
            originX: 'center',
            originY: 'center'
        });

        return group;
    }

    createMovementArrow(x, y) {
        const lineLength = 60;
        
        // Create the dashed line
        const line = new fabric.Line([0, 0, lineLength, 0], {
            stroke: '#333333',
            strokeWidth: 2,
            strokeDashArray: [5, 5],
            strokeLineCap: 'round',
            originX: 'center',
            originY: 'center'
        });

        // Create arrowhead pointing right (triangle rotated 90 degrees)
        const arrowHead = new fabric.Triangle({
            left: lineLength,
            top: 0,
            width: 10,
            height: 10,
            fill: '#333333',
            angle: 90, // This rotates the triangle to point right
            originX: 'center',
            originY: 'center'
        });

        const group = new fabric.Group([line, arrowHead], {
            left: x,
            top: y,
            hasControls: true,
            hasBorders: true,
            originX: 'center',
            originY: 'center'
        });

        return group;
    }

    createArea(x, y) {
        return new fabric.Rect({
            left: x,
            top: y,
            width: 100,
            height: 60,
            fill: 'transparent',
            stroke: '#333333',
            strokeWidth: 1,
            strokeDashArray: [5, 5],
            hasControls: true,
            hasBorders: true,
            lockUniScaling: false
        });
    }

    createObstacle(x, y) {
        return new fabric.Triangle({
            left: x,
            top: y,
            width: 30,
            height: 30,
            fill: 'transparent',
            stroke: '#333333',
            strokeWidth: 2,
            hasControls: true,
            hasBorders: true,
            originX: 'center',
            originY: 'center'
        });
    }

    createEquipment(x, y) {
        // Create diamond shape by rotating a square
        const rect = new fabric.Rect({
            width: 25,
            height: 25,
            fill: 'transparent',
            stroke: '#333333',
            strokeWidth: 2,
            originX: 'center',
            originY: 'center'
        });

        const group = new fabric.Group([rect], {
            left: x,
            top: y,
            angle: 45,
            hasControls: true,
            hasBorders: true
        });

        return group;
    }

    drawGrid() {
        if (!this.showGrid) return;

        const gridGroup = new fabric.Group([], {
            selectable: false,
            evented: false,
            excludeFromExport: true
        });

        const width = this.canvas.getWidth();
        const height = this.canvas.getHeight();

        // Vertical lines
        for (let x = 0; x <= width; x += this.gridSize) {
            const line = new fabric.Line([x, 0, x, height], {
                stroke: '#e0e0e0',
                strokeWidth: 1,
                selectable: false,
                evented: false
            });
            gridGroup.addWithUpdate(line);
        }

        // Horizontal lines
        for (let y = 0; y <= height; y += this.gridSize) {
            const line = new fabric.Line([0, y, width, y], {
                stroke: '#e0e0e0',
                strokeWidth: 1,
                selectable: false,
                evented: false
            });
            gridGroup.addWithUpdate(line);
        }

        this.canvas.add(gridGroup);
        this.canvas.sendToBack(gridGroup);
    }

    toggleGrid() {
        this.showGrid = !this.showGrid;
        this.canvas.getObjects().forEach(obj => {
            if (obj.excludeFromExport) {
                this.canvas.remove(obj);
            }
        });
        
        if (this.showGrid) {
            this.drawGrid();
        }
        this.canvas.requestRenderAll();
    }

    zoom(delta) {
        this.zoomLevel += delta;
        this.zoomLevel = Math.max(0.1, Math.min(3, this.zoomLevel)); // Clamp between 0.1 and 3
        
        this.canvas.setZoom(this.zoomLevel);
        this.canvas.requestRenderAll();
    }

    resetZoom() {
        this.zoomLevel = 1;
        this.canvas.setZoom(1);
        this.canvas.requestRenderAll();
    }

    downloadPNG() {
        // Temporarily hide grid for export
        const gridObjects = this.canvas.getObjects().filter(obj => obj.excludeFromExport);
        gridObjects.forEach(obj => obj.visible = false);

        const dataURL = this.canvas.toDataURL({
            format: 'png',
            quality: 1,
            multiplier: 2 // Higher resolution for download
        });

        // Restore grid visibility
        gridObjects.forEach(obj => obj.visible = true);
        this.canvas.requestRenderAll();

        const link = document.createElement('a');
        link.download = `class-diagram-${new Date().getTime()}.png`;
        link.href = dataURL;
        link.click();
    }

    clearCanvas() {
        if (confirm('Are you sure you want to clear the canvas? This cannot be undone.')) {
            const objects = this.canvas.getObjects().filter(obj => !obj.excludeFromExport);
            objects.forEach(obj => this.canvas.remove(obj));
            this.canvas.requestRenderAll();
            this.hideProperties();
        }
    }

    showProperties(object) {
        const panel = document.getElementById('propertiesPanel');
        panel.innerHTML = '';

        if (!object) return;

        const type = this.getObjectType(object);
        const properties = document.createElement('div');
        
        properties.innerHTML = `
            <h6>${type} Properties</h6>
            <div class="form-group">
                <label>Color:</label>
                <input type="color" id="objectColor" value="${this.getObjectColor(object)}" class="form-control form-control-sm">
            </div>
            ${type === 'Area' ? `
            <div class="form-group">
                <label>Width:</label>
                <input type="number" id="objectWidth" value="${Math.round(object.width * object.scaleX)}" class="form-control form-control-sm">
            </div>
            <div class="form-group">
                <label>Height:</label>
                <input type="number" id="objectHeight" value="${Math.round(object.height * object.scaleY)}" class="form-control form-control-sm">
            </div>
            ` : ''}
            <div class="d-flex gap-1 mt-2">
                <button id="deleteObject" class="btn btn-danger btn-sm flex-fill">Delete</button>
                <button id="duplicateObject" class="btn btn-secondary btn-sm flex-fill">Duplicate</button>
            </div>
            <div class="mt-1 small text-muted">
                <em>Tip: Press Delete key or double-click to delete</em>
            </div>
        `;

        panel.appendChild(properties);

        // Bind property change events
        document.getElementById('objectColor').addEventListener('change', (e) => {
            this.updateObjectColor(object, e.target.value);
        });

        if (type === 'Area') {
            document.getElementById('objectWidth').addEventListener('change', (e) => {
                this.updateObjectSize(object, 'width', parseInt(e.target.value));
            });
            document.getElementById('objectHeight').addEventListener('change', (e) => {
                this.updateObjectSize(object, 'height', parseInt(e.target.value));
            });
        }

        document.getElementById('deleteObject').addEventListener('click', () => {
            this.canvas.remove(object);
            this.canvas.requestRenderAll();
            this.hideProperties();
        });

        document.getElementById('duplicateObject').addEventListener('click', () => {
            this.duplicateObject(object);
        });
    }

    duplicateObject(object) {
        object.clone((cloned) => {
            cloned.set({
                left: object.left + 20,
                top: object.top + 20
            });
            this.canvas.add(cloned);
            this.canvas.setActiveObject(cloned);
            this.canvas.requestRenderAll();
            this.showProperties(cloned);
        });
    }

    hideProperties() {
        this.updateTooltip();
    }

    getObjectType(object) {
        if (object instanceof fabric.Circle) return 'Student';
        if (object instanceof fabric.Group) {
            // Check if it's a teacher by looking for the smile path
            if (object._objects && object._objects.some(obj => obj instanceof fabric.Path)) return 'Teacher';
            if (object._objects && object._objects.some(obj => obj.strokeDashArray)) return 'Movement Arrow';
            return 'Facing Arrow';
        }
        if (object instanceof fabric.Rect) return 'Area';
        if (object instanceof fabric.Triangle) return 'Obstacle';
        return 'Equipment';
    }

    getObjectColor(object) {
        if (object.stroke) return object.stroke;
        if (object._objects && object._objects[0] && object._objects[0].stroke) return object._objects[0].stroke;
        return '#000000';
    }

    updateObjectColor(object, color) {
        if (object instanceof fabric.Group) {
            object._objects.forEach(obj => {
                if (obj.stroke) obj.set('stroke', color);
                if (obj.fill && obj.fill !== 'transparent') obj.set('fill', color);
            });
        } else {
            if (object.stroke) object.set('stroke', color);
        }
        this.canvas.requestRenderAll();
    }

    updateObjectSize(object, dimension, value) {
        if (dimension === 'width') {
            object.set('scaleX', value / object.width);
        } else {
            object.set('scaleY', value / object.height);
        }
        this.canvas.requestRenderAll();
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing DiagramTool...');
    new DiagramTool();
});
</script>
{% endblock %}